#!/usr/bin/env bash


usage() {
  echo "usage: $(basename $0) [-h|--help] [-n|--no-cljs]"
  echo
  echo "  OPTIONS:"
  echo
  echo "  -h|--help show this help text"
  echo "  -n|--no-cljs skip CLJS compilation"
}

POSITIONAL=()
while [[ $# -gt 0 ]]
do
key="$1"

case $key in
    -h|--help)
    # show usage and bail
    usage
    exit
    ;;
    -n|--no-cljs)
    SKIP_CLJS=1
    shift # past argument
    ;;
    *)
    POSITIONAL+=("$1") # save it in an array for later
    shift # past argument
    ;;
esac

done
set -- "${POSITIONAL[@]}" # restore positional parameters


# Build production styles
clojure -M:prod -m rtc.env

# Build JS assets
yarn
if [[ -z $SKIP_CLJS ]] ; then
  clojure -M:cljs-build release app
fi

# Bundle all assets in an uberjar
cd "$( dirname "${BASH_SOURCE[0]}" )"
clojure -m uberdeps.uberjar --deps-file ../deps.edn --target ../target/rtc.jar --aliases prod

# Cleanup after ourselves to avoid interfering with the dev env
# TODO make it so dev just ignores manifest.edn
rm -rf resources/public/css/manifest.edn
